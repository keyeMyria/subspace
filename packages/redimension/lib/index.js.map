{"version":3,"sources":["webpack://Redimension/webpack/universalModuleDefinition","webpack://Redimension/webpack/bootstrap","webpack://Redimension/./src/index.js","webpack://Redimension/./src/redimension.js"],"names":["root","factory","exports","module","define","amd","global","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","redimension","client","hashkey","dimensions","precision","buildElementString","values","id","checkDimensions","encoded","encode","appended","reduce","a","x","insert","ele","multi","zadd","hset","remove","zremAsync","removeById","async","hgetAsync","Error","zrem","hdel","update","old","query","range","ordered","map","deltas","delta","Math","min","exp","size","int10","ranges","b","start","end","e","length","push","current","slice","notDone","rangeStart","rangeEnd","allResults","cb","batch","execAsync","zrangebylex","results","result","item","fields","split","skip","v","queryRaw","zip","parseInt","interleaved","flatten","arr","res","len","cur","Array","isArray","bin","toString","padStart","join"],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"Redimension\"] = factory();\n\telse\n\t\troot[\"Redimension\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","// @flow\n\nimport { redimension } from \"./redimension\"\n\nexport type * from \"./types\"\n\nexport default redimension\n","// @flow\n\nimport type { RedisClientPromisified } from \"redis\"\nimport type { Redimension, Range, Values } from \"./types\"\n\nconst zip = (a: any[], b: any[]) => a.map((x, i) => [x, b[i]])\nconst int10 = (a: number | string) => parseInt(a, 10)\n\nfunction flatten(arr, res = []) {\n  const len = arr.length\n  let i = 0\n  let cur\n\n  for (; i < len; i++) {\n    cur = arr[i]\n    if (Array.isArray(cur)) {\n      flatten(cur, res)\n    } else {\n      res.push(cur)\n    }\n  }\n\n  return res\n}\n\nfunction multi(\n  client: RedisClientPromisified,\n  cb: RedisClientPromisified => *,\n) {\n  const m = client.multi()\n\n  cb(m)\n\n  return m.execAsync()\n}\n\nfunction batch(\n  client: RedisClientPromisified,\n  cb: RedisClientPromisified => *,\n) {\n  const b = client.batch()\n\n  cb(b)\n\n  return b.execAsync()\n}\n\nfunction checkDimensions(\n  values: $ReadOnlyArray<any>,\n  dimensions: number,\n) {\n  if (values.length !== dimensions) {\n    throw new Error(\n      `Please always use ${dimensions} dimensions with this index.`,\n    )\n  }\n}\n\nfunction encode(\n  values: Values,\n  dimensions: number,\n  precision: number,\n) {\n  const comb = values.reduce((a, x, i) => {\n    const bin = x\n      .toString(2)\n      .padStart(precision, \"0\")\n      .split(\"\")\n\n    return i === 0 ? bin : zip(a, bin)\n  }, [])\n  const interleaved = flatten(comb).join(\"\")\n\n  return int10(interleaved)\n    .toString(16)\n    .padStart(precision * dimensions / 4, \"0\")\n}\n\nexport function redimension(\n  client: RedisClientPromisified,\n  key: string,\n  hashkey: string,\n  dimensions: number,\n  precision: number = 64,\n): Redimension {\n  function buildElementString(values: Values, id: string) {\n    checkDimensions(values, dimensions)\n\n    const encoded = encode(values, dimensions, precision)\n    const appended = values.reduce((a, x) => `${a}:${x}`, encoded)\n\n    return `${appended}:${id}`\n  }\n\n  function insert(values: Values, id: string) {\n    const ele = buildElementString(values, id)\n\n    return multi(client, m => {\n      m.zadd(key, 0, ele)\n      m.hset(hashkey, id, ele)\n    })\n  }\n\n  function remove(values: Values, id: string) {\n    const ele = buildElementString(values, id)\n\n    return client.zremAsync(key, ele)\n  }\n\n  async function removeById(id: string) {\n    const ele = await client.hgetAsync(hashkey, id)\n\n    if (!ele) {\n      throw new Error(`Element ${id} not found.`)\n    }\n\n    return multi(client, m => {\n      m.zrem(key, ele)\n      m.hdel(hashkey, id)\n    })\n  }\n\n  async function update(values: Values, id: string) {\n    const ele = buildElementString(values, id)\n    const old = await client.hgetAsync(hashkey, id)\n\n    if (!old) {\n      throw new Error(`Element ${id} not found.`)\n    }\n\n    return multi(client, m => {\n      m.zrem(key, old)\n      m.hdel(hashkey, id)\n      m.zadd(key, 0, ele)\n      m.hset(hashkey, id, ele)\n    })\n  }\n\n  async function queryRaw(range: Range[], exp: number) {\n    const start = []\n    const end = []\n    const e = 2 ** exp\n\n    for (let i = 0; i < range.length; i++) {\n      const r = range[i]\n      start.push(int10(r[0] / e))\n      end.push(int10(r[1] / e))\n    }\n\n    const ranges = []\n    const current = start.slice()\n    let notDone = true\n\n    while (notDone) {\n      const rangeStart = []\n      const rangeEnd = []\n\n      for (let i = 0; i < dimensions; i++) {\n        rangeStart.push(int10(current[i] * e))\n        rangeEnd.push(int10(rangeStart[i] | (e - 1)))\n      }\n\n      ranges.push([\n        `[${encode(rangeStart, dimensions, precision)}:`,\n        `[${encode(rangeEnd, dimensions, precision)}:\\xff`,\n      ])\n\n      for (let i = 0; i < dimensions; i++) {\n        if (current[i] !== end[i]) {\n          current[i] += 1\n          break\n        } else if (i === dimensions - 1) {\n          notDone = false\n        } else {\n          current[i] = start[i]\n        }\n      }\n    }\n\n    const allResults = await batch(client, p => {\n      for (let i = 0; i < ranges.length; i++) {\n        const r = ranges[i]\n        p.zrangebylex(key, r[0], r[1])\n      }\n    })\n\n    const results = []\n\n    for (let r = 0; r < allResults.length; r++) {\n      const result = allResults[r]\n\n      for (let i = 0; i < result.length; i++) {\n        const item = result[i]\n        const fields = item.split(\":\")\n        let skip = false\n\n        for (let d = 0; d < dimensions; d++) {\n          if (\n            int10(fields[d + 1]) < range[d][0] ||\n            int10(fields[d + 1]) > range[d][1]\n          ) {\n            skip = true\n            break\n          }\n        }\n\n        if (!skip) {\n          const values = []\n          const id = fields[fields.length - 1]\n\n          for (let v = 1; v < fields.length - 1; v++) {\n            values.push(int10(fields[v]))\n          }\n\n          results.push([values, id])\n        }\n      }\n    }\n\n    return results\n  }\n\n  function query(range: Range[]) {\n    checkDimensions(range, dimensions)\n\n    const ordered = range.map(r => {\n      if (r[0] < r[1]) {\n        return r\n      }\n      return [r[1], r[0]]\n    })\n    const deltas = ordered.map(r => r[1] - r[0] + 1)\n\n    let delta = Math.min(...deltas)\n    let exp = 1\n\n    while (delta > 2) {\n      delta /= 2\n      exp += 1\n    }\n\n    while (true) {\n      const size = 2 ** exp\n      const d = ordered.map(\n        r => int10(r[1] / size) - int10(r[0] / size) + 1,\n      )\n\n      const ranges = d.reduce((a, b) => a * b)\n\n      if (ranges < 20) {\n        break\n      }\n\n      exp += 1\n    }\n\n    return queryRaw(ordered, exp)\n  }\n\n  return {\n    insert,\n    remove,\n    removeById,\n    update,\n    query,\n  }\n}\n"],"sourceRoot":""}